<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
  <meta http-equiv="Pragma" content="no-cache">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Extract Archaeological Data from PDF</title>
  <style>
    :root {
      --bg: #fff;
      --surface: #f7fbff;
      --text: #0b1a2b;
      --muted: #5a6b83;
      --border: #e6eefc;
      --primary: #2b88ff;
      --primary-6: #166fe0;
      --ok: #2e7d32;
      --warn: #8d6e63;
      --err: #c62828
    }

    html,
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font: 16px/1.55 system-ui, Segoe UI, Roboto, Arial, sans-serif
    }

    a {
      color: inherit;
      text-decoration: none
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: .85rem 1.25rem;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(180deg, #fff 0%, var(--surface) 100%)
    }

    nav a {
      margin-left: .75rem
    }

    main {
      max-width: 1100px;
      margin: 0 auto;
      padding: 1.25rem
    }

    h2 {
      margin: .25rem 0 1rem
    }

    .card {
      border: 1px solid var(--border);
      background: var(--surface);
      border-radius: 14px;
      padding: 1rem
    }

    .row {
      display: flex;
      gap: .6rem;
      align-items: center;
      flex-wrap: wrap
    }

    label {
      font-size: .95rem;
      color: #223
    }

    select,
    input[type=file] {
      border: 1px solid var(--border);
      background: #fff;
      color: var(--text);
      padding: .45rem .55rem;
      border-radius: 10px
    }

    .btn {
      display: inline-block;
      padding: .55rem 1rem;
      border-radius: 10px;
      border: 1px solid var(--primary);
      background: linear-gradient(180deg, var(--primary), var(--primary-6));
      color: #fff;
      cursor: pointer
    }

    .btn.outline {
      background: #fff;
      color: var(--primary-6);
      border: 1px solid #bfdcff
    }

    .hint {
      color: var(--muted);
      font-size: .9rem
    }

    .badge {
      display: inline-block;
      padding: .25rem .6rem;
      border-radius: 999px;
      font-size: .85rem;
      border: 1px solid var(--border);
      background: #fff;
      color: #333
    }

    .badge.pending {
      background: #fff8e1;
      color: var(--warn);
      border-color: #f0e0b2
    }

    .badge.verified {
      background: #e8f5e9;
      color: var(--ok);
      border-color: #c8e6c9
    }

    .badge.rejected {
      background: #ffebee;
      color: var(--err);
      border-color: #ffcdd2
    }

    .bar {
      height: 8px;
      background: #e8eefc;
      border-radius: 999px;
      overflow: hidden;
      display: none
    }

    .bar>span {
      display: block;
      height: 100%;
      width: 0;
      background: linear-gradient(90deg, #74b0ff, #2b88ff);
      transition: width .3s ease
    }

    footer {
      border-top: 1px solid var(--border);
      color: var(--muted);
      text-align: center;
      padding: 1rem;
      margin-top: 1rem
    }
  </style>
</head>

<body>
  <header>
    <a href="/index.html">Arqave</a>
    <nav><a href="/index.html">Home</a><a href="/phase1.html">Phase 1</a></nav>
  </header>

  <main>
    <h2>Extract Archaeological Data from PDF</h2>

    <div class="card">
      <div class="row">
        <label for="pdfFile">Upload PDF</label>
        <input id="pdfFile" type="file" accept="application/pdf">

        <button class="btn" id="uploadBtn">Upload & Process</button>
        <a id="downloadBtn" class="btn outline" style="display:none">Download</a>
        <span class="hint" id="rtype"></span>
      </div>

      <div class="row" style="margin-top:.6rem" aria-live="polite" aria-atomic="true">
        <span id="badge" class="badge" style="display:none">pending</span>
        <span id="msg" class="hint"></span>
      </div>

      <div class="bar" id="bar" aria-hidden="true"><span id="barfill"></span></div>
      <span class="sr-only" id="live" aria-live="polite"></span>
    </div>
  </main>

  <footer><small>&copy; 2025</small></footer>

  <script>
    (function () {
      const $ = s => document.querySelector(s);
      const uploadBtn = $('#uploadBtn');
      const fileInput = $('#pdfFile');
      const downloadBtn = $('#downloadBtn');
      const badge = $('#badge');
      const msg = $('#msg');
      const bar = $('#bar');
      const barfill = $('#barfill');
      const live = $('#live');
      const rtype = $('#rtype');

      function setState(state, text = '') {
        if (state === 'idle') {
          badge.style.display = 'none';
          bar.style.display = 'none';
          barfill.style.width = '0';
          msg.textContent = '';
          downloadBtn.style.display = 'none';
          rtype.textContent = '';
          return;
        }
        badge.style.display = 'inline-block';
        badge.className = 'badge ' + state;
        badge.textContent = state;
        if (state === 'pending') {
          msg.textContent = 'Processingâ€¦';
          bar.style.display = 'block';
        } else if (state === 'verified') {
          msg.textContent = text || 'Ready to download.';
          bar.style.display = 'none';
        } else if (state === 'rejected') {
          msg.textContent = text || 'Error';
          bar.style.display = 'none';
        }
        live.textContent = msg.textContent;
      }

      async function poll(jobId) {
        let p = 5;
        const t = setInterval(() => { p = Math.min(100, p + 5); barfill.style.width = p + '%'; }, 800);
        try {
          while (true) {
            const r = await fetch(`/api/pdf/jobs/${jobId}/status`);
            const s = await r.json();
            if (s.status !== 'pending') {
              clearInterval(t);
              let statusText = s.error || '';
              if (s.status === 'verified' && s.extraction_details) {
                const d = s.extraction_details;
                statusText = `Extracted ${d.tables_extracted} table(s).`;
                if (d.tables_dropped > 0) {
                  statusText += ` Dropped ${d.tables_dropped}.`;
                  if (d.drop_reasons && Object.keys(d.drop_reasons).length > 0) {
                    const reasons = Object.entries(d.drop_reasons).map(([r, c]) => `${c} ${r.replace(/_/g, ' ')}`).join(', ');
                    statusText += ` Reasons: ${reasons}.`;
                  }
                }
              }
              setState(s.status, statusText);
              return s;
            }
            await new Promise(res => setTimeout(res, 2000));
          }
        } catch (e) {
          clearInterval(t);
          setState('rejected', 'Network error');
          return { status: 'rejected', error: String(e) };
        }
      }

      uploadBtn.addEventListener('click', async () => {
        const f = fileInput.files?.[0];
        if (!f) { msg.textContent = 'Select a PDF first.'; return; }
        setState('pending');
        const form = new FormData();
        form.append('file', f);

        try {
          const res = await fetch('/api/pdf/upload', { method: 'POST', body: form });
          const j = await res.json();
          if (!res.ok) {
            setState('rejected', j.error || j.detail || 'Upload failed');
            return;
          }
          const st = await poll(j.job_id);
          if (st.status === 'verified') {
            downloadBtn.href = `/api/pdf/jobs/${j.job_id}/download`;
            downloadBtn.style.display = 'inline-block';
            rtype.textContent = 'Result: Excel or ZIP (depending on size)';
          }
        } catch (e) {
          setState('rejected', 'Request failed');
        }
      });
    })();
  </script>
</body>

</html>