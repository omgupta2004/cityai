<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
  <meta http-equiv="Pragma" content="no-cache">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Extract Archaeological Data from PDF</title>
  <style>
    :root{--bg:#fff;--surface:#f7fbff;--text:#0b1a2b;--muted:#5a6b83;--border:#e6eefc;--ok:#2e7d32;--warn:#8d6e63;--err:#c62828;--primary:#2b88ff;--primary-6:#166fe0}
    html,body{margin:0;background:var(--bg);color:var(--text);font:16px/1.55 system-ui,Segoe UI,Roboto,Arial,sans-serif}
    a{color:inherit;text-decoration:none}
    header{display:flex;justify-content:space-between;align-items:center;padding:.85rem 1.25rem;border-bottom:1px solid var(--border);background:linear-gradient(180deg,#fff 0%,var(--surface) 100%)}
    main{max-width:1100px;margin:0 auto;padding:1.25rem}
    h2{margin:.25rem 0 1rem}
    .card{border:1px solid var(--border);background:var(--surface);border-radius:14px;padding:1rem}
    .row{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}
    .btn{display:inline-block;padding:.55rem .9rem;border-radius:10px;border:1px solid var(--primary);background:linear-gradient(180deg,var(--primary),var(--primary-6));color:#fff;cursor:pointer}
    .btn.outline{background:#fff;color:var(--primary-6);border:1px solid #bfdcff}
    .hint{color:var(--muted);font-size:.9rem}
    .badge{display:inline-block;padding:.25rem .55rem;border-radius:999px;font-size:.85rem;border:1px solid var(--border);background:#fff;color:#333}
    .badge.pending{background:#fff8e1;color:var(--warn);border-color:#f0e0b2}
    .badge.verified{background:#e8f5e9;color:var(--ok);border-color:#c8e6c9}
    .badge.rejected{background:#ffebee;color:var(--err);border-color:#ffcdd2}
    .dz{position:relative;display:flex;align-items:center;gap:.5rem;padding:.6rem;border:1px dashed #cfe2ff;background:#fff;border-radius:10px}
    .dz input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer}
    .dz .name{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:380px}
    .bar{height:8px;background:#e8eefc;border-radius:999px;overflow:hidden;display:none}
    .bar>span{display:block;height:100%;width:0;background:linear-gradient(90deg,#74b0ff,#2b88ff);transition:width .3s ease}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
  </style>
</head>
<body>
<header>
  <a href="/index.html">Bi(bli)oArch</a>
  <nav><a href="/index.html">Home</a> <a href="/phase1.html">Phase 1</a></nav>
</header>

<main>
  <h2>Extract Archaeological Data from PDF</h2>
  <div class="card">
    <div class="row">
      <div class="dz" title="Click or drop a PDF here">
        <input id="file" type="file" accept="application/pdf">
        <strong>Upload PDF</strong>
        <span class="name hint" id="fname">No file chosen</span>
      </div>
      <button class="btn" id="run">Upload & Process</button>
      <a id="dl" class="btn outline" style="display:none">Download</a>
      <span class="hint" id="rtype"></span>
    </div>

    <div class="row" style="margin-top:.6rem" aria-live="polite" aria-atomic="true">
      <span id="badge" class="badge pending" style="display:none">pending</span>
      <span id="msg" class="hint"></span>
    </div>

    <div class="bar" id="bar" aria-hidden="true"><span id="barfill"></span></div>
    <span class="sr-only" id="live" aria-live="polite"></span>
  </div>
</main>

<footer style="text-align:center;color:var(--muted);padding:1rem;border-top:1px solid var(--border)"><small>&copy; 2025</small></footer>

<script>
const $ = s=>document.querySelector(s);
const file = $('#file'), run = $('#run'), dl = $('#dl'), fname = $('#fname');
const badge = $('#badge'), msg = $('#msg'), bar = $('#bar'), barfill = $('#barfill'), live = $('#live'), rtype = $('#rtype');

file.addEventListener('change', ()=>{ fname.textContent = file.files?.[0]?.name || 'No file chosen'; });

function setState(state, text=''){
  if(state==='idle'){ badge.style.display='none'; bar.style.display='none'; barfill.style.width='0'; msg.textContent=''; dl.style.display='none'; rtype.textContent=''; return; }
  badge.style.display='inline-block'; badge.className = 'badge '+state; badge.textContent = state;
  msg.textContent = text || (state==='pending'?'Processingâ€¦':state==='verified'?'Ready to download.':'Error');
  if(state==='pending'){ bar.style.display='block'; }
  if(state!=='pending'){ bar.style.display='none'; }
  live.textContent = msg.textContent;
}

async function poll(job){
  let p = 5;
  const t = setInterval(()=>{ p = Math.min(100, p+5); barfill.style.width = p+'%'; }, 800);
  try{
    while(true){
      const r = await fetch(`/api/pdf/jobs/${job}/status`); const s = await r.json();
      if(s.status!=='pending'){ clearInterval(t); setState(s.status, s.error || ''); return s.status; }
      await new Promise(res=>setTimeout(res, 2000));
    }
  }catch{ clearInterval(t); }
}

run.addEventListener('click', async ()=>{
  const f = file.files?.[0]; if(!f){ msg.textContent='Select a PDF.'; return; }
  setState('pending');
  const fd = new FormData(); fd.append('file', f);
  const r = await fetch('/api/pdf/upload', { method:'POST', body:fd });
  const j = await r.json();
  if(!r.ok){ setState('rejected', j.error || 'Upload failed'); return; }
  const status = await poll(j.job_id);
  if(status==='verified'){
    // The server decides result type; try both filenames and set label
    dl.href = `/api/pdf/jobs/${j.job_id}/download`;
    dl.style.display='inline-block';
    rtype.textContent = 'Download CSV ZIP or Excel (depends on file size)';
    dl.textContent = 'Download Result';
  }
});
</script>
</body>
</html>
